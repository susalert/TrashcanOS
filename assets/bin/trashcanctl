#!/bin/bash
# trashcanctl - System Control Utility

COMMAND="$1"
ARG2="$2"
# ðŸ”‘ The Keys
LOCK_FILE="/etc/trashcan/dev-mode-enabled"
RW_LOCK_FILE="/etc/trashcan/rw-mode-enabled" # <--- NEW KEY
LOCK_DIR="/etc/trashcan"

# Colors
RED='\033[0;31m'
YELLOW='\033[1;33m'
GREEN='\033[0;32m'
NC='\033[0m' # No Color

show_help() {
    echo "Usage: trashcanctl [command]"
    echo ""
    echo "Commands:"
    echo "  --enable-dev-tools        Unlock 'rpm-ostree' and 'bootc' commands"
    echo "  --disable-dev-tools       Lock the system again (Safe Mode)"
    echo "  --enable-whole-disk-rw    Make the entire filesystem Read-Write (â˜¢ï¸)"
}

if [ -z "$COMMAND" ]; then
    show_help
    exit 1
fi

if [ "$COMMAND" == "--enable-dev-tools" ]; then
    echo -e "${YELLOW}âš ï¸: You are about to unlock system-level modifications.${NC}"
    echo "This allows usage of 'rpm-ostree' and 'bootc'."
    read -p "Are you sure? (y/N): " confirm
    if [[ $confirm == [yY] || $confirm == [yY][eE][sS] ]]; then
        sudo mkdir -p "$LOCK_DIR"
        sudo touch "$LOCK_FILE"
        echo -e "${GREEN}Dev Tools ENABLED. You can now use rpm-ostree.${NC}"
    else
        echo "Cancelled."
    fi

elif [ "$COMMAND" == "--disable-dev-tools" ]; then
    # ðŸ§¹ CLEANUP: Remove BOTH keys to fully re-lock
    sudo rm -f "$LOCK_FILE"
    sudo rm -f "$RW_LOCK_FILE"
    echo -e "${GREEN}Dev Tools DISABLED. System is safe.${NC}"

elif [ "$COMMAND" == "--enable-whole-disk-rw" ]; then
    # â˜¢ï¸ THE NUCLEAR OPTION â˜¢ï¸
    echo -e "${RED} â˜¢ï¸ WHOLE DISK READ-WRITE MODE â˜¢ï¸ ${NC}"
    echo ""
    echo -e "${RED}You are about to remove the immutability lock.${NC}"
    echo "This allows you to modify, corrupt, or delete core system files."
    echo "Any changes to system files will persist until the next reboot."
    echo -e "${YELLOW}This can completely break your OS installation.${NC}"
    echo ""

    # Confirmation Level 1
    if [ "$ARG2" != "--i-accept-consequences" ]; then
        echo "To proceed, you must use the flag: --i-accept-consequences"
        exit 1
    fi

    echo -e "${RED}âš ï¸: VERIFICATION REQUIRED${NC}"
    echo "Please type 'AGREE' to confirm you want to unlock the filesystem."
    read -p "Input: " confirmation

    if [ "$confirmation" == "AGREE" ]; then
        echo -e "${RED}ðŸ”“: UNLOCKING FILESYSTEM...${NC}"

        # ðŸ”‘ Create the Second Key so the wrapper allows the command
        sudo touch "$RW_LOCK_FILE"

        # The Magic Command
        sudo rpm-ostree usroverlay
        echo ""
        echo -e "${RED}âœ… SYSTEM IS NOW READ-WRITE.${NC}"
        echo "You have full control. Do not cry if it breaks."
    else
        echo "Verification failed. Aborting."
        exit 1
    fi

else
    show_help
fi

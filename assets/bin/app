#!/bin/bash
# app - The TrashcanOS Package Manager Wrapper

COMMAND="$1"
PACKAGE="$2"
CONTAINER_NAME="trashcan-box"

# Colors
GREEN='\033[0;32m'
RED='\033[0;31m'
NC='\033[0m' # No Color

show_help() {
    echo -e "üóëÔ∏è  ${GREEN}TrashcanOS App Manager${NC}"
    echo "Usage:"
    echo "  app install <package>   Install an app (e.g., firefox, vlc)"
    echo "  app remove <package>    Remove an app"
    echo "  app list                List installed apps"
}

if [ -z "$COMMAND" ]; then
    show_help
    exit 1
fi

# Ensure the backend container exists
if ! podman container exists "$CONTAINER_NAME" > /dev/null 2>&1; then
    echo -e "${GREEN}üì¶ Initializing the App Environment (First run only)...${NC}"
    # Create a Fedora container silently
    distrobox create -n "$CONTAINER_NAME" -i registry.fedoraproject.org/fedora:latest -Y > /dev/null
fi

case "$COMMAND" in
    install)
        if [ -z "$TARGET" ]; then
            echo -e "${RED}Error: You must specify a package name or file.${NC}"
            exit 1
        fi

        # --- 1. HANDLE FLATPAKS (Host Level) ---
        # Flatpaks are native to the host, so we don't use the container.
        if [[ "$TARGET" == *.flatpakref ]] || [[ "$TARGET" == *.flatpak ]]; then
             echo -e "${GREEN}üì¶ Detected Flatpak file. Installing to System (User)...${NC}"
             # We use the standard flatpak command
             flatpak install -y "$TARGET"
             echo -e "${GREEN}‚úÖ Flatpak installed!${NC}"
             exit 0
        fi

        # --- 2. HANDLE EVERYTHING ELSE (Container Level) ---
        ensure_container

        # Check: Is it a local .rpm file?
        if [[ "$TARGET" == *.rpm ]]; then
            if [ -f "$TARGET" ]; then
                echo -e "${GREEN}üì¶ Detected local RPM file. Installing in container...${NC}"
                RPM_PATH=$(realpath "$TARGET")
                distrobox enter "$CONTAINER_NAME" -- sudo dnf install -y "$RPM_PATH"
            else
                echo -e "${RED}Error: File '$TARGET' not found.${NC}"
                exit 1
            fi
        else
            # Standard repo package (firefox, neofetch, etc)
            echo -e "${GREEN}‚¨áÔ∏è  Downloading and installing $TARGET...${NC}"
            distrobox enter "$CONTAINER_NAME" -- sudo dnf install -y "$TARGET"
        fi

        # Export to menu
        echo -e "${GREEN}üîó Exporting to host menu...${NC}"
        distrobox enter "$CONTAINER_NAME" -- distrobox-export --export-app "$TARGET" 2>/dev/null || true
        distrobox enter "$CONTAINER_NAME" -- distrobox-export --export-apps

        echo -e "${GREEN}‚úÖ Installation complete!${NC}"
        ;;

    remove)
        if [ -z "$PACKAGE" ]; then
            echo -e "${RED}Error: What do you want to remove?${NC}"
            exit 1
        fi
        distrobox enter "$CONTAINER_NAME" -- sudo dnf remove -y "$PACKAGE"
        echo -e "${GREEN}üóëÔ∏è  $PACKAGE removed.${NC}"
        ;;

    update)
        echo -e "${GREEN}üîÑ Checking for updates...${NC}"
        # Just refresh metadata, don't install yet
        distrobox enter "$CONTAINER_NAME" -- sudo dnf check-update
        ;;

    upgrade)
        echo -e "${GREEN}‚¨ÜÔ∏è  Upgrading all apps...${NC}"
        # Run the actual upgrade
        distrobox enter "$CONTAINER_NAME" -- sudo dnf upgrade -y
        # Refresh menu icons in case they changed
        echo -e "${GREEN}üîó Refreshing menu links...${NC}"
        distrobox enter "$CONTAINER_NAME" -- distrobox-export --export-apps
        echo -e "${GREEN}‚úÖ Upgrade complete.${NC}"
        ;;

    list)
        distrobox enter "$CONTAINER_NAME" -- dnf list installed --userinstalled
        ;;

    *)
        show_help
        ;;
esac

#!/bin/bash
# app - The TrashcanOS Package Manager Wrapper
# üçå TrashcanOS: Chaos Verified.

COMMAND="$1"
TARGET="$2"
CONTAINER_NAME="trashcan-box"

# Colors
GREEN='\033[0;32m'
BLUE='\033[0;34m'
YELLOW='\033[1;33m'
RED='\033[0;31m'
NC='\033[0m' # No Color

# Helper: Ensure the backend container exists and is ALIVE
ensure_container() {
    # 1. Check if it exists at all
    if ! podman container exists "$CONTAINER_NAME" > /dev/null 2>&1; then
        echo -e "${GREEN}üì¶ Initializing the App Environment (First run only)...${NC}"
        # Use quay.io for better speed/reliability
        distrobox create -n "$CONTAINER_NAME" -i quay.io/fedora/fedora:latest -Y > /dev/null
        
        # --- CRITICAL FIX: FORCE INIT ---
        # We enter once with a dummy command to let Distrobox set up basic packages
        echo -e "${BLUE}‚öôÔ∏è  Setting up container internals...${NC}"
        distrobox enter -T "$CONTAINER_NAME" -- true > /dev/null 2>&1
        return
    fi

    # 2. Check if it is actually broken (Zombie check)
    # We use -T here to avoid TTY errors during the check
    if ! distrobox enter -T "$CONTAINER_NAME" -- true > /dev/null 2>&1; then
        echo -e "${RED}‚ö†Ô∏è  Detected corrupted App Environment!${NC}"
        echo -e "${YELLOW}‚ôªÔ∏è  Rebuilding trashcan-box...${NC}"
        distrobox rm "$CONTAINER_NAME" --force > /dev/null 2>&1
        
        # Recreate
        distrobox create -n "$CONTAINER_NAME" -i quay.io/fedora/fedora:latest -Y > /dev/null
        # Init again
        distrobox enter -T "$CONTAINER_NAME" -- true > /dev/null 2>&1
    fi
}

show_help() {
    echo -e "üóëÔ∏è  ${GREEN}TrashcanOS App Manager${NC}"
    echo "Usage:"
    echo "  app install <package|file>   Install an app (rpm, flatpak, or repo name)"
    echo "  app remove <package>         Remove an app"
    echo "  app update [package]         Update apps only (DNF)"
    echo "  app upgrade [package]        Update System (Bootc) + Apps (DNF)"
    echo "  app full-upgrade             Force update EVERYTHING (Flatpak, DNF, Bootc, RPM-OSTree)"
    echo "  app list                     List installed apps"
}

if [ -z "$COMMAND" ]; then
    show_help
    exit 1
fi

case "$COMMAND" in
    install)
        if [ -z "$TARGET" ]; then
            echo -e "${RED}Error: You must specify a package name or file.${NC}"
            exit 1
        fi

        # --- SMART CHECK: Is it already installed? ---
        ensure_container
        # Added -T
        if distrobox enter -T "$CONTAINER_NAME" -- rpm -q "$TARGET" > /dev/null 2>&1; then
            echo -e "${YELLOW}‚ö†Ô∏è  '$TARGET' is already installed.${NC}"
            echo -e "Did you mean to update it? Run: ${GREEN}app update $TARGET${NC}"
            exit 0
        fi
        # ---------------------------------------------

        # --- 1. HANDLE FLATPAKS (Host Level) ---
        if [[ "$TARGET" == *.flatpakref ]] || [[ "$TARGET" == *.flatpak ]]; then
             echo -e "${GREEN}üì¶ Detected Flatpak file. Installing to System (User)...${NC}"
             flatpak install -y "$TARGET"
             echo -e "${GREEN}‚úÖ Flatpak installed!${NC}"
             exit 0
        fi

        # --- 2. HANDLE EVERYTHING ELSE (Container Level) ---
        ensure_container

        # Check: Is it a local .rpm file?
        if [[ "$TARGET" == *.rpm ]]; then
            if [ -f "$TARGET" ]; then
                echo -e "${GREEN}üì¶ Detected local RPM file. Installing in container...${NC}"
                RPM_PATH=$(realpath "$TARGET")
                
                # Added -T
                if distrobox enter -T "$CONTAINER_NAME" -- sudo dnf install -y "$RPM_PATH"; then
                    echo -e "${GREEN}üîó Exporting to host menu...${NC}"
                    distrobox enter -T "$CONTAINER_NAME" -- distrobox-export --app "$TARGET" 2>/dev/null || true
                    echo -e "${GREEN}‚úÖ Installation complete!${NC}"
                else
                    echo -e "${RED}‚ùå Installation FAILED.${NC}"
                    exit 1
                fi
            else
                echo -e "${RED}Error: File '$TARGET' not found.${NC}"
                exit 1
            fi
        else
            # Standard repo package
            echo -e "${GREEN}‚¨áÔ∏è  Downloading and installing $TARGET...${NC}"
            
            # Added -T to fix "Inappropriate ioctl for device"
            if distrobox enter -T "$CONTAINER_NAME" -- sudo dnf install -y "$TARGET"; then
                echo -e "${GREEN}üîó Exporting to host menu...${NC}"
                distrobox enter -T "$CONTAINER_NAME" -- distrobox-export --app "$TARGET" 2>/dev/null || true
                echo -e "${GREEN}‚úÖ Installation complete!${NC}"
            else
                echo -e "${RED}‚ùå Installation FAILED.${NC}"
                exit 1
            fi
        fi
        ;;

    remove)
        if [ -z "$TARGET" ]; then
            echo -e "${RED}Error: What do you want to remove?${NC}"
            exit 1
        fi
        ensure_container
        
        # --- FIX: REMOVE SHORTCUT FIRST ---
        echo -e "${YELLOW}üßπ Cleaning up shortcuts for $TARGET...${NC}"
        # Added -T
        distrobox enter -T "$CONTAINER_NAME" -- distrobox-export --delete "$TARGET" 2>/dev/null || true
        # ----------------------------------

        # Added -T
        distrobox enter -T "$CONTAINER_NAME" -- sudo dnf remove -y "$TARGET"
        echo -e "${GREEN}üóëÔ∏è  $TARGET removed.${NC}"
        ;;

    update)
        ensure_container
        if [ -z "$TARGET" ]; then
            # No argument: Update ALL Apps
            echo -e "${GREEN}üì¶ Updating all Container Apps...${NC}"
            # Added -T
            distrobox enter -T "$CONTAINER_NAME" -- sudo dnf upgrade --refresh -y
            echo -e "${GREEN}‚úÖ App updates complete.${NC}"
        else
            # Argument provided: Update specific App
            echo -e "${GREEN}üì¶ Updating package: $TARGET...${NC}"
            # Added -T
            distrobox enter -T "$CONTAINER_NAME" -- sudo dnf upgrade --refresh -y "$TARGET"
            echo -e "${GREEN}‚úÖ Update complete.${NC}"
        fi
        ;;

    upgrade)
        # 1. Update Apps
        ensure_container
        if [ -z "$TARGET" ]; then
            echo -e "${BLUE}============ 1/2: UPDATING APPS ============${NC}"
            # Added -T
            distrobox enter -T "$CONTAINER_NAME" -- sudo dnf upgrade --refresh -y

            echo -e "${BLUE}============ 2/2: UPDATING SYSTEM (Bootc) ============${NC}"
            echo -e "${YELLOW}Checking for TrashcanOS Core Updates...${NC}"
            sudo /usr/bin/bootc upgrade

            echo -e "${GREEN}‚úÖ System & App Upgrade Complete.${NC}"
        else
            # If user specifies a package, just update that package
            echo -e "${GREEN}üì¶ Updating package: $TARGET...${NC}"
            # Added -T
            distrobox enter -T "$CONTAINER_NAME" -- sudo dnf upgrade --refresh -y "$TARGET"
        fi
        ;;

    full-upgrade)
        if [ ! -z "$TARGET" ]; then
             echo -e "${RED}Error: 'full-upgrade' does not accept package names. It updates EVERYTHING.${NC}"
             exit 1
        fi

        echo -e "${RED}‚ö†Ô∏è WARNING: Performing a FULL SYSTEM overhaul${NC}"

        # 1. Flatpaks
        echo -e "${BLUE}üì¶ [1/4] Updating Flatpaks...${NC}"
        flatpak update -y

        # 2. Containers
        echo -e "${BLUE}üßä [2/4] Updating Container Apps...${NC}"
        ensure_container
        # Added -T
        distrobox enter -T "$CONTAINER_NAME" -- sudo dnf upgrade --refresh -y

        # 3. System Base (Bootc)
        echo -e "${BLUE}üíø [3/4] Updating TrashcanOS Core...${NC}"
        sudo /usr/bin/bootc upgrade

        # 4. Layered Packages (RPM-OSTree)
        echo -e "${BLUE}üõ°Ô∏è  [4/4] Updating Layered Drivers...${NC}"
        sudo /usr/bin/rpm-ostree upgrade

        echo -e "${GREEN}‚úÖ FULL SYSTEM UPGRADE COMPLETE!${NC}"
        echo -e "${YELLOW}‚ÑπÔ∏è  Please reboot if System/Core updates were applied.${NC}"
        ;;

    list)
        ensure_container
        # Added -T
        distrobox enter -T "$CONTAINER_NAME" -- dnf list installed --userinstalled
        ;;

    *)
        show_help
        ;;
esac

#!/bin/bash
# Wrapper to block dangerous commands unless Dev Mode is enabled

REAL_CMD=$(basename "$0")
LOCK_FILE="/etc/trashcan/dev-mode-enabled"

# --- üîì EXCEPTIONS (Allow specific commands to bypass the lock) ---

# 1. ALLOW 'bootc install'
# Why: The image builder (bib) NEEDS this to generate QCOW2/ISO images.
# Also, running 'bootc install' requires root and targets a disk, so it's an admin task.
if [[ "$REAL_CMD" == "bootc" ]] && [[ "$1" == "install" ]]; then
    exec "/usr/bin/$REAL_CMD" "$@"
fi

# 2. ALLOW 'status' checks
# Why: Users should be able to check version info/status without unlocking.
if [[ "$1" == "status" ]]; then
    exec "/usr/bin/$REAL_CMD" "$@"
fi

# ------------------------------------------------------------------

if [ -f "$LOCK_FILE" ]; then
    # Dev mode is ON. Execute the REAL command from /usr/bin
    exec "/usr/bin/$REAL_CMD" "$@"
else
    # Dev mode is OFF. Block it.
    echo "‚õî ACCESS DENIED: System is in Safe Mode."
    echo "This command ($REAL_CMD) can modify the immutable core."
    echo ""
    echo "To unlock, run: trashcanctl --enable-dev-tools"
    echo "‚ö†Ô∏è  You assume full responsibility for system stability."
    exit 1
fi

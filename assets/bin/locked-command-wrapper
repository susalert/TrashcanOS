#!/bin/bash
# Wrapper to block dangerous commands unless Dev Mode is enabled

REAL_CMD=$(basename "$0")
LOCK_FILE="/etc/trashcan/dev-mode-enabled"
RW_LOCK_FILE="/etc/trashcan/rw-mode-enabled" # <--- Check for Second Key

# --- ðŸ”“ EXCEPTIONS (Allow specific commands to bypass the lock) ---

# 1. ALLOW 'bootc install'
# Why: The image builder (bib) NEEDS this to generate QCOW2/ISO images.
if [[ "$REAL_CMD" == "bootc" ]] && [[ "$1" == "install" ]]; then
    exec "/usr/bin/$REAL_CMD" "$@"
fi

# 2. ALLOW 'status' checks
# Why: Users should be able to check version info/status without unlocking.
if [[ "$1" == "status" ]]; then
    exec "/usr/bin/$REAL_CMD" "$@"
fi

# ------------------------------------------------------------------

if [ -f "$LOCK_FILE" ]; then
    # Dev mode is ON.

    # ðŸ›‘ SECURITY CHECK: Is the user trying to modify the live filesystem?
    # We block 'usroverlay' (rpm-ostree) and 'usr-overlay' (bootc)
    if [[ "$1" == "usroverlay" ]] || [[ "$1" == "usr-overlay" ]]; then
        if [ ! -f "$RW_LOCK_FILE" ]; then
            echo -e "\033[0;31mâ›” ACCESS DENIED: Live Modification Locked.\033[0m"
            echo "You have Dev Tools enabled, but this command requires full Read-Write access."
            echo ""
            echo -e "To unlock live editing, run: \033[1;33mtrashcanctl --enable-whole-disk-rw --i-accept-consequences\033[0m"
            exit 1
        fi
    fi

    # If we passed the check, execute the REAL command
    exec "/usr/bin/$REAL_CMD" "$@"
else
    # Dev mode is OFF. Block it.
    echo "â›” ACCESS DENIED: System is in Safe Mode."
    echo "This command ($REAL_CMD) can modify the immutable core."
    echo ""
    echo "To unlock, run: trashcanctl --enable-dev-tools"
    echo "âš ï¸  You assume full responsibility for system stability."
    exit 1
fi
